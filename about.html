<div class="page slide-up">
  <h2>About</h2>

  <p>Hello! Welcome to the yellow world. I'm Surbhi ‚Äî creator of Solasaki Comics.
  I make simple comics inspired by my weird observations.
  You can also read my writeups if you have nothing better to do.</p>

  <h3>Draw something!</h3>

  <div id="draw-area">
    <canvas id="doodleCanvas"></canvas>

    <!-- Tools -->
    <div class="tools">
      <button id="pencilBtn" class="tool active">‚úèÔ∏è Pencil</button>
      <button id="eraserBtn" class="tool">ü©π Eraser</button>
      <button id="undoBtn" class="tool">‚Ü©Ô∏è Undo</button>
      <button id="saveBtn" class="save-btn">Save Doodle</button>
    </div>
  </div>

  <h3>Visitors' doodles</h3>
  <div id="doodlesGallery"></div>
</div>

<script type="module">
  import { supabase } from "./scripts/supabase.js";

  /* Canvas Setup */
  const canvas = document.getElementById("doodleCanvas");
  const ctx = canvas.getContext("2d");
  let drawing = false;
  let tool = "pencil";
  let strokeColor = "#000000";
  let strokeSize = 3;

  // Undo stack
  let history = [];

  // Auto-resize canvas
  function resizeCanvas() {
    canvas.width = document.getElementById("draw-area").offsetWidth - 20;
    canvas.height = 300;
    ctx.fillStyle = "#faf7ef"; // background
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }
  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  function saveState() {
    history.push(canvas.toDataURL());
    if (history.length > 25) history.shift();
  }

  canvas.addEventListener("mousedown", (e) => {
    drawing = true;
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
    saveState();
  });

  canvas.addEventListener("mousemove", (e) => {
    if (!drawing) return;
    ctx.lineWidth = strokeSize;
    ctx.lineCap = "round";
    ctx.strokeStyle = tool === "eraser" ? "#faf7ef" : "#000000";
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  });

  canvas.addEventListener("mouseup", () => drawing = false);
  canvas.addEventListener("mouseleave", () => drawing = false);

  /* Tools */
  document.getElementById("pencilBtn").onclick = () => {
    tool = "pencil";
    strokeColor = "#000";
    document.getElementById("pencilBtn").classList.add("active");
    document.getElementById("eraserBtn").classList.remove("active");
  };

  document.getElementById("eraserBtn").onclick = () => {
    tool = "eraser";
    document.getElementById("eraserBtn").classList.add("active");
    document.getElementById("pencilBtn").classList.remove("active");
  };

  document.getElementById("undoBtn").onclick = () => {
    if (history.length <= 1) return;
    history.pop();
    let previous = new Image();
    previous.src = history[history.length - 1];
    previous.onload = () => ctx.drawImage(previous, 0, 0, canvas.width, canvas.height);
  };

  /* Upload to Supabase */
  document.getElementById("saveBtn").onclick = async () => {
    const dataUrl = canvas.toDataURL("image/png");
    const fileName = `doodle-${Date.now()}.png`;

    const { data, error } = await supabase.storage
      .from("doodles")
      .upload(fileName, dataUrl.split(",")[1], {
        contentType: "image/png",
        upsert: false
      });

    if (error) {
      alert("Error saving doodle!");
      return;
    }

    loadDoodles();
  };

  /* Load stored doodles */
  async function loadDoodles() {
    const { data } = await supabase.storage.from("doodles").list("", { limit: 20 });

    const gallery = document.getElementById("doodlesGallery");
    gallery.innerHTML = "";

    data?.forEach(file => {
      const url = `${supabase.storageUrl}/object/public/doodles/${file.name}`;
      const img = document.createElement("img");
      img.src = url;
      img.className = "doodle-thumb";
      gallery.appendChild(img);
    });
  }

  loadDoodles();
</script>

<style>
  #draw-area {
    border: 2px dashed var(--border);
    padding: 10px;
    background: #faf7ef;
    margin-bottom: 20px;
    border-radius: 12px;
  }

  canvas {
    width: 100%;
    height: 300px;
    border-radius: 10px;
    background: #faf7ef;
  }

  .tools {
    margin-top: 12px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .tool {
    padding: 8px 14px;
    border-radius: 8px;
    border: 2px solid var(--border);
    background: white;
    cursor: pointer;
  }

  .tool.active {
    background: #d3bef1;
    border-color: #b592e8;
  }

  .save-btn {
    background: #b88fbf;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 8px;
  }

  #doodlesGallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
    margin-top: 15px;
  }

  .doodle-thumb {
    width: 100%;
    border-radius: 10px;
    border: 2px dashed var(--border);
  }
</style>
